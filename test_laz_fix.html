<!DOCTYPE html>
<html>
<head>
    <title>LAZ Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .pass { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .fail { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>LAZ Processing Fix Test</h1>
    <p>This test verifies that LAZ files don't trigger unwanted Sentinel-2 calls.</p>
    
    <div id="test-results"></div>
    
    <script>
        // Mock the necessary objects for testing
        window.FileManager = {
            selectedRegion: null,
            getSelectedRegion: () => window.FileManager.selectedRegion,
            getRegionPath: (regionName) => {
                if (regionName && regionName.includes('laz')) {
                    return '/input/LAZ/' + regionName + '.laz';
                }
                return '/input/regions/' + regionName;
            }
        };
        
        window.Utils = {
            log: (level, ...args) => {
                console.log(`[${level.toUpperCase()}]`, ...args);
                logOutput.push(`[${level.toUpperCase()}] ${args.join(' ')}`);
            }
        };
        
        let logOutput = [];
        let sentinel2CallCount = 0;
        
        // Mock Sentinel-2 function to track calls
        const mockDisplaySentinel2 = (regionName) => {
            sentinel2CallCount++;
            Utils.log('info', `MOCK: displaySentinel2ImagesForRegion called for ${regionName}`);
        };
        
        // Test functions (simplified versions of the actual fixes)
        
        // Test 1: handleGlobalRegionSelection fix
        function testHandleGlobalRegionSelection(regionName) {
            logOutput = [];
            sentinel2CallCount = 0;
            
            Utils.log('info', `Testing handleGlobalRegionSelection with region: ${regionName}`);
            
            // Check if this is a LAZ file
            const filePath = FileManager.getRegionPath(regionName);
            const isLAZFile = filePath.toLowerCase().includes('.laz');
            
            if (!isLAZFile) {
                mockDisplaySentinel2(regionName);
            } else {
                Utils.log('info', 'Skipping Sentinel-2 call for LAZ file - LAZ files are LiDAR point cloud data, not satellite imagery');
            }
            
            return { sentinel2CallCount, logs: [...logOutput] };
        }
        
        // Test 2: handleProcessingSuccess fix
        function testHandleProcessingSuccess(processingType, selectedRegion) {
            logOutput = [];
            sentinel2CallCount = 0;
            
            Utils.log('info', `Testing handleProcessingSuccess with type: ${processingType}, region: ${selectedRegion}`);
            
            // Check if this is LAZ-based processing
            const regionPath = FileManager.getRegionPath(selectedRegion);
            const isLAZProcessing = regionPath && regionPath.toLowerCase().includes('.laz');
            
            if (selectedRegion && !isLAZProcessing) {
                Utils.log('info', `Refreshing Sentinel-2 images for region: ${selectedRegion}`);
                mockDisplaySentinel2(selectedRegion);
            } else if (isLAZProcessing) {
                Utils.log('info', 'Skipping Sentinel-2 refresh for LAZ-based processing - LAZ files are LiDAR point cloud data, not satellite imagery');
            }
            
            return { sentinel2CallCount, logs: [...logOutput] };
        }
        
        // Test 3: getCombinedData fix
        function testGetCombinedData(effectiveRegionName, selectedRegion) {
            logOutput = [];
            sentinel2CallCount = 0;
            
            Utils.log('info', `Testing getCombinedData with effectiveRegionName: ${effectiveRegionName}, selectedRegion: ${selectedRegion}`);
            
            const displayRegionName = effectiveRegionName;
            
            // Check if this is a LAZ file region
            const isLAZRegion = selectedRegion && 
                               (selectedRegion.toLowerCase().includes('.laz') || 
                                displayRegionName.toLowerCase().includes('laz'));
            
            if (!isLAZRegion) {
                mockDisplaySentinel2(displayRegionName);
            } else {
                Utils.log('info', 'Skipping Sentinel-2 display for LAZ region - LAZ files are LiDAR point cloud data, not satellite imagery');
            }
            
            return { sentinel2CallCount, logs: [...logOutput] };
        }
        
        // Run tests
        function runTests() {
            const results = [];
            
            // Test 1: LAZ file should NOT trigger Sentinel-2
            Utils.log('info', '=== Test 1: LAZ file processing ===');
            const test1 = testHandleGlobalRegionSelection('FoxIsland_laz');
            results.push({
                name: 'LAZ file region selection',
                passed: test1.sentinel2CallCount === 0,
                details: `Sentinel-2 calls: ${test1.sentinel2CallCount}, Expected: 0`,
                logs: test1.logs
            });
            
            // Test 2: Regular file SHOULD trigger Sentinel-2
            Utils.log('info', '=== Test 2: Regular file processing ===');
            const test2 = testHandleGlobalRegionSelection('region_001');
            results.push({
                name: 'Regular region selection',
                passed: test2.sentinel2CallCount === 1,
                details: `Sentinel-2 calls: ${test2.sentinel2CallCount}, Expected: 1`,
                logs: test2.logs
            });
            
            // Test 3: LAZ processing should NOT trigger Sentinel-2
            Utils.log('info', '=== Test 3: LAZ processing success ===');
            FileManager.selectedRegion = 'FoxIsland.laz';
            const test3 = testHandleProcessingSuccess('dtm', 'FoxIsland.laz');
            results.push({
                name: 'LAZ processing success',
                passed: test3.sentinel2CallCount === 0,
                details: `Sentinel-2 calls: ${test3.sentinel2CallCount}, Expected: 0`,
                logs: test3.logs
            });
            
            // Test 4: Regular processing SHOULD trigger Sentinel-2
            Utils.log('info', '=== Test 4: Regular processing success ===');
            FileManager.selectedRegion = 'region_001';
            const test4 = testHandleProcessingSuccess('dtm', 'region_001');
            results.push({
                name: 'Regular processing success',
                passed: test4.sentinel2CallCount === 1,
                details: `Sentinel-2 calls: ${test4.sentinel2CallCount}, Expected: 1`,
                logs: test4.logs
            });
            
            // Test 5: LAZ region in getCombinedData should NOT trigger Sentinel-2
            Utils.log('info', '=== Test 5: LAZ getCombinedData ===');
            const test5 = testGetCombinedData('FoxIsland_laz', 'FoxIsland.laz');
            results.push({
                name: 'LAZ region in getCombinedData',
                passed: test5.sentinel2CallCount === 0,
                details: `Sentinel-2 calls: ${test5.sentinel2CallCount}, Expected: 0`,
                logs: test5.logs
            });
            
            // Test 6: Regular region in getCombinedData SHOULD trigger Sentinel-2
            Utils.log('info', '=== Test 6: Regular getCombinedData ===');
            const test6 = testGetCombinedData('region_001', 'region_001');
            results.push({
                name: 'Regular region in getCombinedData',
                passed: test6.sentinel2CallCount === 1,
                details: `Sentinel-2 calls: ${test6.sentinel2CallCount}, Expected: 1`,
                logs: test6.logs
            });
            
            return results;
        }
        
        function displayResults(results) {
            const container = document.getElementById('test-results');
            
            const summary = results.filter(r => r.passed).length;
            const total = results.length;
            
            container.innerHTML = `
                <div class="test-result ${summary === total ? 'pass' : 'fail'}">
                    <h3>Test Summary: ${summary}/${total} tests passed</h3>
                </div>
            `;
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.passed ? 'pass' : 'fail'}`;
                div.innerHTML = `
                    <h4>${result.name}: ${result.passed ? 'PASS' : 'FAIL'}</h4>
                    <p>${result.details}</p>
                    <details>
                        <summary>View logs</summary>
                        <pre>${result.logs.join('\\n')}</pre>
                    </details>
                `;
                container.appendChild(div);
            });
        }
        
        // Run tests when page loads
        window.addEventListener('DOMContentLoaded', () => {
            const results = runTests();
            displayResults(results);
        });
    </script>
</body>
</html>
